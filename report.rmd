---
title: "A fundamental pipeline for methylation data analysis"
author: Stefano Roncelli
date: "`r format(Sys.time(), '%d/%m/%y')`"
output: pdf_document
---
# Introduction
In this work we apply some basic concepts seen in the theory lessons and apply them on a dataset of Illymina methylation data.
The dataset is composed of 8 slides, which are samples taken from four patients affected with down sydrome (`DS`) and four healthy wyld-type subjects (`WT`).

Student NÂ° 26
Address 10633381
p-value threshold: 0.01
normalization preprocessSWAN
Mann_whitney test

Starting from scratch, we have to load the necessary packages. This is done by loading the `easypackages` library that simplyfies library loading procedures.
Load raw data with minfi and create an object called RGset storing the RGChannelSet object
```{r step-1, message = FALSE, warning = FALSE}
setwd('.')
library(easypackages)
libraries("minfi", "RColorBrewer", "ggplot2", "gap", "gplots", "tidyr", "reshape2", "magrittr", "dplyr", "tibble", "future.apply")
```

```{r loading-rgset, message = FALSE, warning = FALSE}
baseDir <- ('./Input_data')
targets <- read.metharray.sheet(baseDir)
RGset <- read.metharray.exp(targets = targets)
save(RGset, file = "RGset.RData")
RGset
```

# Step 2
Create the dataframes Red and Green to store the red and green fluorescences respectively
```{r loading-green-red, message = FALSE, warning = FALSE}
Red <- data.frame(getRed(RGset))
Green <- data.frame(getGreen(RGset))
```

# Step 3
Fill the following table: what are the Red and Green fluorescences for the address assigned to you?
Optional: check in the manifest file if the address corresponds to a Type I or a Type II probe and, in case of Type I probe, report its color.

For the optional procedure we will create two dataframes `type_I` and `type_II`, which will be reused later on for the normalization.
```{r step-3, message = FALSE, warning = FALSE}

type_I <- getProbeInfo(RGset, type = 'I')
type_II <- getProbeInfo(RGset, type = 'II')
type_I[type_I$AddressA == 10633381,]
type_I[type_I$AddressB == 10633381,]
type_II[type_II$AddressA == 10633381,]
Red[rownames(Red) == '10633381',]
Green[rownames(Green) == '10633381',]
```
We can see it's a type I infinium with the Red channel.

| Sample               | Row | Column | Red Intensity | Green Intensity | Type | Color |
|----------------------|-----|--------|---------------|-----------------|------|-------|
| 5775278051           | 1   | 1      | 1852          | 458             | I    | Red   |
| 5775278051           | 4   | 2      | 1694          | 631             | I    | Red   |
| 5775278078           | 2   | 1      | 1354          | 358             | I    | Red   |
| 5775278078           | 5   | 1      | 1091          | 396             | I    | Red   |
| 5775278078           | 5   | 2      | 1131          | 424             | I    | Red   |
| 5930514034           | 1   | 2      | 796           | 302             | I    | Red   |
| 5930514035           | 4   | 2      | 894           | 354             | I    | Red   |
| 5930514035           | 6   | 2      | 1149          | 479             | I    | Red   |

# Step 4
Create the object MSet.raw
For the creation of the MSet.raw we use the preprocessRaw function
```{r step-4}
MSet.raw <- preprocessRaw(RGset)
```

# Step 5
Perform the following quality checks and provide a brief comment to each step:
- QCplot

```{r qc}
qc <- getQC(MSet.raw)
plotQC(qc)
```

- check the intensity of negative controls using minfi

```{r strip-plot}
controlStripPlot(RGset, controls = "NEGATIVE")
```
- calculate detection pValues; for each sample, how many probes have a detection p-value higher than the threshold assigned to each student?
The function to use is detectionP, which takes as input the RGset.

```{r failed-probes, message=FALSE, warning=FALSE}
detection_p_value <- detectionP(RGset)
dim(detection_p_value)
failed_probes <- detection_p_value > 0.01
table(failed_probes)
summary(failed_probes)
```
The following table summarizes the failed positions

| Sample | Group |      Slide | Row | Col  | Failed probes (p-value > 0.01) |
|--------|-------|------------|-----|------|--------------------------------|
| 1020   | DS    | 5775278051 | 1   | 1    |                            323 |
| 1036   | DS    | 5775278051 | 4   | 2    |                            260 |
| 3038   | WT    | 5775278078 | 2   | 1    |                            312 |
| 3042   | WT    | 5775278078 | 5   | 1    |                            485 |
| 3052   | WT    | 5775278078 | 5   | 2    |                            465 |
| 1016   | DS    | 5930514034 | 1   | 2    |                            123 |
| 1029   | DS    | 5930514035 | 4   | 2    |                             60 |
| 3029   | WT    | 5930514035 | 6   | 2    |                            149 |


# Step 6
Calculate raw beta and M values and plot the densities of mean methylation values, dividing the samples in DS and WT
(suggestion: subset the beta and M values matrixes in order to retain DS or WT subjects and apply the function mean to the 2 subsets).

For the retrieval of the $\beta$ and $M$ values we use the `getBeta` and `getM` functions respectively.
```{r step-6-a, message=FALSE, warning=FALSE}
intensities <- getBeta(MSet.raw) %>%
        melt(value.name = "RawBeta", varnames = c("ID", "Slide"))
M_values <- getM(MSet.raw) %>%
        melt()
intensities["RawM"] <- M_values$value
summary(intensities)
```
We now add a columnt for the Sample status, which can be either Down Syndrome (`DS`) or WildType(`WT`).
```{r step-6-b, message=FALSE, warning=FALSE}
slide_DS <- colnames(RGset[,targets$Group == "WT"])
intensities["status"] <- ifelse(intensities$Slide %in% slide_DS, "DS", "WT")
```

Computing the mean for $\beta$ and $M$ subsets and both groups
```{r step-6-c, message=FALSE, warning=FALSE}
par(mfrow = c(1, 2))

intensities %>%
        filter(status == "WT") %>%
        group_by(ID) %>%
        summarise(mean = mean(RawBeta, na.rm = T)) %>%
        select(mean) %>%
        unlist() %>%
        as.numeric() %>%
        density() %>%
        plot(main = expression(paste("Density of ", beta, " values"), col = "green"))
intensities %>%
        filter(status == "DS") %>%
        group_by(ID) %>%
        summarise(mean = mean(RawBeta, na.rm = T)) %>%
        select(mean) %>%
        unlist() %>%
        as.numeric() %>%
        density() %>%
        lines(col = "green")
intensities %>%
        filter(status == "WT") %>%
        group_by(ID) %>%
        summarise(mean = mean(RawM, na.rm = T)) %>%
        select(mean) %>%
        unlist() %>%
        as.numeric() %>%
        density() %>%
        plot(main = expression(paste("Density of ", beta, " values"), col = "green"))
intensities %>%
        filter(status == "DS") %>%
        group_by(ID) %>%
        summarise(mean = mean(RawM, na.rm = T)) %>%
        select(mean) %>%
        unlist() %>%
        as.numeric() %>%
        density() %>%
        lines(col = "green")
```

# Step 7
Normalize the data using the function assigned to each student and compare raw data and normalized data.
Produce a plot with 6 panels in which, for both raw and normalized data, you show the density plots of beta mean values according to the chemistry of the probes, the density plot of beta standard deviation values according to the chemistry of the probes and the boxplot of beta values.
Provide a short comment regarding the changes you observe.

Producing the plots
```{r normalization, message=FALSE, warning=FALSE}
intensities["Infinium"] <- ifelse(intensities$ID %in% type_I$Name, "I", "II")

# Normalization with preprocessSWAN
intensities["NormBeta"] <-
        RGset %>%
                preprocessSWAN() %>%
                getBeta() %>%
                melt() %>%
                select(value)
```


```{r raw-vs-norm, message=FALSE, warning=FALSE}
par(mfrow = c(2, 3))

# Plotting raw beta for type I
intensities %>%
        filter(Infinium == "I") %>%
        group_by(ID) %>%
        summarise(mean = mean(RawBeta, na.rm = T)) %>%
        select(mean) %>%
        unlist() %>%
        as.numeric() %>%
        density() %>%
        plot(main = expression(paste("Density of ", beta, " values"), col = "green"))

# Plotting raw beta for type II
intensities %>%
        filter(Infinium == "II") %>%
        group_by(ID) %>%
        summarise(mean = mean(RawBeta, na.rm = T)) %>%
        select(mean) %>%
        unlist() %>%
        as.numeric() %>%
        density() %>%
        lines(col = "blue")

# Plotting raw beta standard deviatio for type I
intensities %>%
        filter(Infinium == "I") %>%
        group_by(ID) %>%
        summarise(sd = sd(RawBeta, na.rm = T)) %>%
        select(sd) %>%
        unlist() %>%
        as.numeric() %>%
        density() %>%
        plot(main = expression(paste("Density of ", beta, " values"), col = "green"))

# Plotting raw beta standard deviatio for type II
intensities %>%
        filter(Infinium == "II") %>%
        group_by(ID) %>%
        summarise(sd = sd(RawBeta, na.rm = T)) %>%
        select(sd) %>%
        unlist() %>%
        as.numeric() %>%
        density() %>%
        lines(col = "blue")
# Plotting Boxplot for Raw Data
boxplot(RawBeta~Slide, intensities)

# Plotting normalized beta for type I
intensities %>%
        filter(Infinium == "I") %>%
        group_by(ID) %>%
        summarise(mean = mean(NormBeta, na.rm = T)) %>%
        select(mean) %>%
        unlist() %>%
        as.numeric() %>%
        density() %>%
        plot(main = expression(paste("Density of ", beta, " values"), col = "green"))

# Plotting normalized beta for type II
intensities %>%
        filter(Infinium == "II") %>%
        group_by(ID) %>%
        summarise(mean = mean(NormBeta, na.rm = T)) %>%
        select(mean) %>%
        unlist() %>%
        as.numeric() %>%
        density() %>%
        lines(col = "blue")

# Plotting normalized beta standard deviation for type I
intensities %>%
        filter(Infinium == "I") %>%
        group_by(ID) %>%
        summarise(sd = sd(NormBeta, na.rm = T)) %>%
        select(sd) %>%
        unlist() %>%
        as.numeric() %>%
        density() %>%
        plot(main = expression(paste("Density of ", beta, " values"), col = "green"))

# Plotting normalized beta standard deviation for type II
intensities %>%
        filter(Infinium == "II") %>%
        group_by(ID) %>%
        summarise(sd = sd(NormBeta, na.rm = T)) %>%
        select(sd) %>%
        unlist() %>%
        as.numeric() %>%
        density() %>%
        lines(col = "blue")
# Boxplot for normalized bera values
boxplot(NormBeta~Slide, intensities)
```
Step 8
Perform a PCA on the beta matrix generated in step 7. Comment the plot.

```{r pca-data, message=FALSE, warning=FALSE}
pca_results <- intensities %>%
        select(c(ID, Slide, NormBeta)) %>%
        dcast(ID~Slide, value.var = "NormBeta") %>%
        column_to_rownames(var = 'ID') %>%
        t() %>%
        prcomp(scale = T) %T>%
        summary() %T>%
        plot()
```
We can see how the 8th component doesn't carry any variance.

```{r pca-plot, message=FALSE, warning=FALSE}
palette("default")
groups <- factor(targets$Group)
plot(pca_results$x[, 1], pca_results$x[, 2],
  pch = 16,
  col = groups,
  xlab = "PC1",
  ylab = "PC2"
)
legend(
  "bottomleft",
  legend = levels(groups),
  col = c(1:nlevels(groups)),
  pch = 16
)
```
Step 9
Using the matrix of normalized beta values generated in step 7, identify differentially methylated probes between group DS and group WT using the functions assigned to each student.
Note; it can take several minutes; if you encounter any problem you can run the differential methylated analysis only on a subset of probes (for example those on chromosome 1, 18 and 21)


```{r mann-whitney, message=FALSE, warning=FALSE}
mann_whitney <- function(x) {
  wilcox <- wilcox.test(x ~ groups)
  return(wilcox$p.value)
}
plan(multisession)
intensities["PvalRaw"] <- intensities %>%
  select(c(ID, Slide, NormBeta)) %>%
  dcast(ID ~ Slide, value.var = "NormBeta") %>%
  column_to_rownames(var = 'ID') %>%
  future_apply(1, mann_whitney) %T>%
  summary() %T>%
  length()
```
Step 10
Apply multiple test correction and set a significant threshold of 0.01.
How many probes do you identify as differentially methylated considering nominal pValues?
How many after Bonferroni correction?
How many after BH correction?
```{r bh-bonf, message=FALSE, warning=FALSE}
intensities["PvalBH"] <- p.adjust(intensities$PvalRaw, "BH")
intensities["PvalBonf"] <- p.adjust(intensities$PvalRaw, "bonferroni")
```

```{r pvalue-plot, message=FALSE, warning=FALSE}
intensities%>%
  select(PvalRaw, PvalBH, PvalBonf) %>%
  boxplot()
```
Step 11
Produce an heatmap of the top 100 differentially mehtylated probes
```{r step-11, message=FALSE, warning=FALSE}
plot_data <- intensities %>%
        select(c(ID, Slide, NormBeta, PvalRaw)) %>%
        dcast(ID + PvalRaw ~ Slide, value.var = "NormBeta") %>%
        column_to_rownames(var = 'ID') %>%
        slice_min(PvalRaw, with_ties = F, n = 100) %>%
        select(-PvalRaw) %>%
        as.matrix()

colorbar <- c("orange", "orange", "#008080", "#008080", "#008080", "orange", "orange", "#008080")
palette <- brewer.pal(100, name = "Greys")
par(mfrow = c(1, 3))

# complete linkage
heatmap.2(plot_data,
          col = palette,
          Rowv = T,
          Colv = T,
          dendrogram = "both",
          key = T,
          ColSideColors = colorbar,
          density.info = "none",
          trace = "none",
          scale = "none",
          symm = F,
          main = "Normalized Beta values - complete linkage")

# Single linkage
heatmap.2(plot_data,
          col = palette,
          Rowv = T,
          Colv = T,
          hclustfun = function(x) hclust(x, method = 'single'),
          dendrogram = "both",
          key = T,
          ColSideColors = colorbar,
          density.info = "none",
          trace = "none",
          scale = "none",
          symm = F,
          main = "Norm Beta values (Method: single linkage)")
# averge linkage
heatmap.2(plot_data,
          col = palette,
          Rowv = T,
          Colv = T, hclustfun = function(x) hclust(x, method = 'average'),
          dendrogram = "both",
          key = T, ColSideColors = colorbar,
          density.info = "none",
          trace = "none",
          scale = "none",
          symm = F,
          main = "Norm Beta values (Method: average linkage)")

```


Step 12
Produce a volcano plot and a Manhattan plot of the results of differential methylation analysis
```{r, message=FALSE, warning=FALSE}
volplot_data <-
intensities %>%
       # filter(status == "DS") %>%
        select(c(ID, NormBeta, Slide, status)) %>%
        group_by(ID, status) %>%
        summarise(mean = mean(NormBeta, na.rm = T)) %>%
        group_by(ID) %>%
        summarise(Delta = diff(mean)) %>%
        select(Delta)

volplot_data["PvalRaw"] <- intensities %>%
        select(c(ID, PvalRaw)) %>%
        distinct() %>%
        select(PvalRaw)
```

```{r volcano-plot, message=FALSE, warning=FALSE}
Highlight <- volplot_data[abs(volplot_data$Delta) > 0.1 & volplot_data$PvalRaw > (-log10(0.01)),]
plot(volplot_data$Delta, -log10(volplot_data$PvalRaw), pch = 16, cex = 0.5, ylab = "p-Values", xlab = "delta", ylim = c(0, 2)) - log10(0.05)
abline(a = -log10(0.01), b = 0, col = "red")
points(Highlight[, 1], Highlight[, 2], pch = 16, cex = 0.7, col = "red")
```

```{r, message=FALSE, warning=FALSE}
annotation <- getAnnotation(RGset)
manhattan_data <- intensities %>%
        select(Name = ID, PvalRaw) %>%
        distinct() %>%
        merge(annotation, by = "Name") %>%
        droplevels()
```

```{r manhattan-dataprep message, message=FALSE, warning=FALSE}
chr_vect <- factor(manhattan_data$chr, levels = c("chr1",
                                                  "chr2",
                                                  "chr3",
                                                  "chr4",
                                                  "chr5",
                                                  "chr6",
                                                  "chr7",
                                                  "chr8",
                                                  "chr9",
                                                  "chr10",
                                                  "chr11",
                                                  "chr12",
                                                  "chr13",
                                                  "chr14",
                                                  "chr15",
                                                  "chr16",
                                                  "chr17",
                                                  "chr18",
                                                  "chr19",
                                                  "chr20",
                                                  "chr21",
                                                  "chr22",
                                                  "chrX",
                                                  "chrY"))
manhattan_data_input <- data.frame(chr_vect, manhattan_data$pos, manhattan_data$PvalRaw)
```
```{r manhattan-plot, message=FALSE, warning=FALSE}
palette <- rainbow(24)
mhtplot(manhattan_data_input, control = mht.control(colors = palette), ylim = c(0,3))
```

Step 13 (optional)
As DS is caused by the trisomy of chromosome 21, try also to plot the density of the methylation values of the probes mapping on chromosome 21.
```{r, message=FALSE, warning=FALSE}
# chr21 <- RGset[annotation$CHR == "chr21"]
# chr21 <- manhattan_data[manhattan_data$CHR == "chr21"]

```
Do you see a very clear difference between the samples?
How many differentially methylated probes do you find on chromosome 21?

