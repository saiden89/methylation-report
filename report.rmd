---
title: "Pipeline for methylation assay"
author: Stefano Roncelli
date: "`r format(Sys.time(), '%d/%m/%y')`"
output: pdf_document
---
Student NÂ° 26
Address 10633381
p-value threshold: 0.01
normalization preprocessSWAN
Mann_whitney test

Load raw data with minfi and create an object called RGset storing the RGChannelSet object
```{r step-1, message = FALSE, warning = FALSE}
setwd('.')
suppressMessages(library(minfi))
suppressMessages(library(magrittr))
baseDir <- ('./Input_data')
targets <- read.metharray.sheet(baseDir)
RGset <- read.metharray.exp(targets = targets)
save(RGset, file = "RGset.RData")
RGset
```

# Step 2
Create the dataframes Red and Green to store the red and green fluorescences respectively
```{r step-2, message = FALSE, warning = FALSE}
Red <- data.frame(getRed(RGset))
Green <- data.frame(getGreen(RGset))
```

# Step 3
Fill the following table: what are the Red and Green fluorescences for the address assigned to you?
Optional: check in the manifest file if the address corresponds to a Type I or a Type II probe and, in case of Type I probe, report its color.

For the optional procedure we will create two dataframes `type_I` and `type_II`, which will be reused later on for the normalization.
```{r step-3, message = FALSE, warning = FALSE}

type_I <- getProbeInfo(RGset, type = 'I')
type_II <- getProbeInfo(RGset, type = 'II')
type_I[type_I$AddressA == 10633381,]
type_I[type_I$AddressB == 10633381,]
type_II[type_II$AddressA == 10633381,]
Red[rownames(Red) == '10633381',]
Green[rownames(Green) == '10633381',]
```
We can see it's a type I infinium with the Red channel.

| Sample               | Row | Column | Red Intensity | Green Intensity | Type | Color |
|----------------------|-----|--------|---------------|-----------------|------|-------|
| 5775278051           | 1   | 1      | 1852          | 458             | I    | Red   |
| 5775278051           | 4   | 2      | 1694          | 631             | I    | Red   |
| 5775278078           | 2   | 1      | 1354          | 358             | I    | Red   |
| 5775278078           | 5   | 1      | 1091          | 396             | I    | Red   |
| 5775278078           | 5   | 2      | 1131          | 424             | I    | Red   |
| 5930514034           | 1   | 2      | 796           | 302             | I    | Red   |
| 5930514035           | 4   | 2      | 894           | 354             | I    | Red   |
| 5930514035           | 6   | 2      | 1149          | 479             | I    | Red   |

# Step 4
Create the object MSet.raw
For the creation of the MSet.raw we use the preprocessRaw function
```{r step-4}
MSet.raw <- preprocessRaw(RGset)
```

# Step 5
Perform the following quality checks and provide a brief comment to each step:
- QCplot

```{r step-5-a}
qc <- getQC(MSet.raw)
plotQC(qc)
```

- check the intensity of negative controls using minfi

```{r step-5-b}
controlStripPlot(RGset, controls = "NEGATIVE")
```
- calculate detection pValues; for each sample, how many probes have a detection p-value higher than the threshold assigned to each student?
The function to use is detectionP, which takes as input the RGset.

```{r step-5-c, message=FALSE, warning=FALSE}
detection_p_value <- detectionP(RGset)
dim(detection_p_value)
failed_probes <- detection_p_value > 0.01
table(failed_probes)
summary(failed_probes)
```
The following table summarizes the failed positions

| Sample | Group |      Slide | Row | Col  | Failed probes (p-value > 0.01) |
|--------|-------|------------|-----|------|--------------------------------|
| 1020   | DS    | 5775278051 | 1   | 1    |                            323 |
| 1036   | DS    | 5775278051 | 4   | 2    |                            260 |
| 3038   | WT    | 5775278078 | 2   | 1    |                            312 |
| 3042   | WT    | 5775278078 | 5   | 1    |                            485 |
| 3052   | WT    | 5775278078 | 5   | 2    |                            465 |
| 1016   | DS    | 5930514034 | 1   | 2    |                            123 |
| 1029   | DS    | 5930514035 | 4   | 2    |                             60 |
| 3029   | WT    | 5930514035 | 6   | 2    |                            149 |


# Step 6
Calculate raw beta and M values and plot the densities of mean methylation values, dividing the samples in DS and WT
(suggestion: subset the beta and M values matrixes in order to retain DS or WT subjects and apply the function mean to the 2 subsets).

For the retrieval of the $\beta$ and $M$ values we use the `getBeta` and `getM` functions respectively.
```{r step-6-a, message = FALSE}
beta_value <- getBeta(MSet.raw)
summary(beta_value)
M_value <- getM(MSet.raw)
summary(M_value)
```
We now subset `beta_value` and `M_value` to obtain the Wild-Type (`WT`) and Down-Syndrome (`DS`).
```{r step-6-b}
DS_status <- targets$Group == 'DS'
summary(DS_status)
beta_value_DS <- beta_value[, DS_status]
beta_value_WT <- beta_value[, !DS_status]
M_value_DS <- M_value[, DS_status]
M_value_WT <- M_value[, !DS_status]
```

Computing the mean for $\beta$ and $M$ subsets and both groups
```{r step-6-c}
par(mfrow = c(1, 2))

beta_value_WT %>%
        apply(1, mean, na.rm = T) %>%
        density() %T>%
        plot(main = expression(paste("Density of ", beta, " values"), col = "green"))

beta_value_DS %>%
        apply(1, mean, na.rm = T) %>%
        density() %T>%
        lines(col = "blue")

M_value_WT %>%
        apply(1, mean, na.rm = T) %>%
        density() %T>%
        plot(main = "Density of M values", col = "green")

M_value_DS %>%
        apply(1, mean, na.rm = T) %>%
        density() %T>%
        lines(col = "blue")
```
# Step 7
Normalize the data using the function assigned to each student and compare raw data and normalized data.
Produce a plot with 6 panels in which, for both raw and normalized data, you show the density plots of beta mean values according to the chemistry of the probes, the density plot of beta standard deviation values according to the chemistry of the probes and the boxplot of beta values.
Provide a short comment regarding the changes you observe.

Producing the plots
```{r step-7-a, message = FALSE}
beta_type_I <- beta_value[rownames(beta_value) %in% type_I$Name, ]
beta_type_II <- beta_value[rownames(beta_value) %in% type_II$Name, ]

# Normalization with preprocessSWAN
beta_norm <-
  RGset %>%
  preprocessSWAN() %>%
    getBeta()

beta_type_I_norm <- beta_norm[rownames(beta_norm) %in% type_I$Name, ]
beta_type_II_norm <- beta_norm[rownames(beta_norm) %in% type_II$Name, ]

par(mfrow=c(2,3))
# Plotting raw beta for type I
beta_type_I %>%
  apply(1, mean, na.rm = T) %>%
  density() %T>%
  plot(main = expression(paste("Raw ", beta)), col = "blue")

# Plotting raw beta for type II
beta_type_II %>%
        apply(1, mean, na.rm = T) %>%
        density() %T>%
        lines(col = "red")

# Plotting raw standard deviation for type I
beta_type_I %>%
        apply(1, sd, na.rm = T) %>%
        density() %T>%
        plot(main = expression(paste("Raw standard deviation for ", beta, " values")), col = "blue")

# Plotting raw standard deviation for type II
beta_type_II %>%
        apply(1, sd, na.rm = T) %>%
        density() %T>%
        lines(col = "red")

# Plotting bowplot for raw beta
boxplot(beta_value)

# Plotting the normlized beta mean for type
beta_type_I_norm %>%
        apply(1, mean, na.rm = T) %>%
        density() %T>%
        plot(col = "blue", main = "normalized beta")

# Plotting the normalized beta for type II probes
beta_type_II_norm %>%
        apply(1, mean, na.rm = T) %>%
        density() %T>%
        lines(col = "red")

# Plotting the normalized standard deviation for type I probes
beta_type_I_norm %>%
        apply(1, sd, na.rm = T) %>%
        density() %T>%
        plot(col = "blue", main = "normalized standard deviation")

# Plotting the normalized standard deviation for type II probes
beta_type_II_norm %>%
        apply(1, sd, na.rm = T) %>%
        density() %T>%
        lines(col = "red")

# Plotting boxplot for normalized beta value
boxplot(beta_norm)
```


Step 8
Perform a PCA on the beta matrix generated in step 7. Comment the plot.

```{r}
pca_results <-
  beta_norm %>%
    t() %>%
    prcomp(scale = T) %T>%
    summary() %T>%
    plot()
```
We can see how the 8th component doesn't carry any variance.

```{r step-8-b}
palette("default")
groups <- factor(targets$Group)
plot(pca_results$x[, 1], pca_results$x[, 2],
  pch = 16,
  col = groups,
  xlab = "PC1",
  ylab = "PC2"
)
legend(
  "bottomleft",
  legend = levels(groups),
  col = c(1:nlevels(groups)),
  pch = 16
)
```
Step 9
Using the matrix of normalized beta values generated in step 7, identify differentially methylated probes between group DS and group WT using the functions assigned to each student.
Note; it can take several minutes; if you encounter any problem you can run the differential methylated analysis only on a subset of probes (for example those on chromosome 1, 18 and 21)


```{r}
mann_whitney <- function(x) {
  wilcox <- wilcox.test(x ~ groups)
  return(wilcox$p.value)
}
pval_raw <- apply(beta_norm, 1, mann_whitney)
summary(pval_raw)
length(pval_raw)
```

Step 10
Apply multiple test correction and set a significant threshold of 0.01.
How many probes do you identify as differentially methylated considering nominal pValues?
How many after Bonferroni correction?
How many after BH correction?
```{r step-10}
beta_rawp_df <- data.frame(beta_norm, pval_raw)
beta_rawp_df_sorted <- beta_rawp_df[order(beta_rawp_df$pval_raw), ]
summary(beta_rawp_df_sorted)
raw_p_sorted <- beta_rawp_df_sorted[, 9]
summary(raw_p_sorted)
BH_p <- p.adjust(raw_p_sorted, "BH")
summary(BH_p)
Bonf_p <- p.adjust(raw_p_sorted, "bonferroni")
summary(Bonf_p)
```

Step 11
Produce an heatmap of the top 100 differentially mehtylated probes

Step 12
Produce a volcano plot and a Manhattan plot of the results of differential methylation analysis

Step 13 (optional)
As DS is caused by the trisomy of chromosome 21, try also to plot the density of the methylation values of the probes mapping on chromosome 21.
Do you see a very clear difference between the samples?
How many differentially methylated probes do you find on chromosome 21?

